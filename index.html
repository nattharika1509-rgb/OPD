// กำหนดชื่อ Sheet ที่จะใช้เป็นฐานข้อมูล
const SHEET_PATIENTS = "Patients";
const SHEET_VISITS = "Visits";

// ฟังก์ชันเริ่มต้น (ตั้งค่า Sheet อัตโนมัติถ้ายังไม่มี)
function setup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // สร้างชีต Patients ถ้ายังไม่มี
  if (!ss.getSheetByName(SHEET_PATIENTS)) {
    const sheet = ss.insertSheet(SHEET_PATIENTS);
    sheet.appendRow(["Timestamp", "CID", "Name", "DOB", "Age", "Gender", "Phone", "Rights", "Congenital", "Allergy"]);
    sheet.getRange("A1:J1").setFontWeight("bold").setBackground("#fce7f3");
  }
  
  // สร้างชีต Visits ถ้ายังไม่มี
  if (!ss.getSheetByName(SHEET_VISITS)) {
    const sheet = ss.insertSheet(SHEET_VISITS);
    sheet.appendRow(["Timestamp", "Time", "Name", "Age", "Gender", "Symptoms", "Triage", "BP", "Temp", "PR", "RR", "Pain Score", "Status"]);
    sheet.getRange("A1:M1").setFontWeight("bold").setBackground("#dbeafe");
  }
}

// -------------------------------------------------------------
// จัดการ HTTP GET (การดึงข้อมูล และ การค้นหา)
// -------------------------------------------------------------
function doGet(e) {
  // รัน setup อัตโนมัติในครั้งแรก
  setup();
  
  const action = e.parameter.action;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  try {
    // 1. ค้นหาประวัติคนไข้เก่า
    if (action === 'search') {
      const keyword = e.parameter.keyword.toString().toLowerCase();
      const sheet = ss.getSheetByName(SHEET_PATIENTS);
      const data = sheet.getDataRange().getValues();
      const headers = data[0];
      
      let results = [];
      // วนลูปเริ่มจากบรรทัดที่ 2 (ข้าม Header)
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const cid = row[1].toString();
        const name = row[2].toString().toLowerCase();
        
        // ถ้า CID หรือ ชื่อ มีคำที่ค้นหา
        if (cid.includes(keyword) || name.includes(keyword)) {
          results.push({
            cid: row[1],
            name: row[2],
            age: row[4],
            gender: row[5],
            congenital: row[8],
            allergy: row[9]
          });
        }
      }
      return createJsonResponse({ result: "success", data: results });
    }
    
    // 2. ดึงคิวตรวจสำหรับหน้าแพทย์ (ค่าเริ่มต้นเมื่อไม่มี action)
    else {
      const sheet = ss.getSheetByName(SHEET_VISITS);
      const data = sheet.getDataRange().getValues();
      
      let visits = [];
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const status = row[12];
        
        // ดึงเฉพาะคนที่สถานะยังไม่ใช่ "ตรวจแล้ว" (หรือว่างๆ คือรอตรวจ)
        if (status !== "ตรวจแล้ว") {
          visits.push({
            time: row[1],
            name: row[2],
            age: row[3],
            gender: row[4],
            symptoms: row[5],
            triage: row[6],
            vitals: {
              bp: row[7],
              temp: row[8],
              pr: row[9],
              rr: row[10],
              pain_score: row[11]
            }
          });
        }
      }
      return createJsonResponse(visits);
    }
  } catch (error) {
    return createJsonResponse({ result: "error", message: error.toString() });
  }
}

// -------------------------------------------------------------
// จัดการ HTTP POST (การบันทึกข้อมูล)
// -------------------------------------------------------------
function doPost(e) {
  setup();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  try {
    // รับข้อมูลที่ส่งมาจาก Frontend
    let data;
    if (e.postData.type === "application/json") {
      data = JSON.parse(e.postData.contents);
    } else {
      // รองรับกรณี no-cors ที่ frontend ส่งมาเป็น text/plain
      data = JSON.parse(e.postData.contents);
    }
    
    // 1. บันทึกลงทะเบียนคนไข้ใหม่
    if (data.action === 'register') {
      const sheet = ss.getSheetByName(SHEET_PATIENTS);
      sheet.appendRow([
        new Date(),       // Timestamp
        data.cid,         // CID
        data.name,        // Name
        data.dob,         // DOB
        data.age,         // Age
        data.gender,      // Gender
        data.phone,       // Phone
        data.rights,      // Rights
        data.congenital,  // Congenital
        data.allergy      // Allergy
      ]);
      return createJsonResponse({ result: "success", message: "Patient registered" });
    }
    
    // 2. บันทึกข้อมูลคัดกรอง (ส่งเข้าคิวตรวจ)
    else if (data.action === 'visit') {
      const sheet = ss.getSheetByName(SHEET_VISITS);
      sheet.appendRow([
        new Date(),                 // Timestamp
        data.time,                  // Time
        data.name,                  // Name
        data.age,                   // Age
        data.gender,                // Gender
        data.symptoms,              // Symptoms
        data.triage,                // Triage
        data.vitals.bp,             // BP
        data.vitals.temp,           // Temp
        data.vitals.pr,             // PR
        data.vitals.rr,             // RR
        data.vitals.pain_score,     // Pain Score
        "รอตรวจ"                     // Status
      ]);
      return createJsonResponse({ result: "success", message: "Visit recorded" });
    }
    
    return createJsonResponse({ result: "error", message: "Unknown action" });
    
  } catch (error) {
    return createJsonResponse({ result: "error", message: error.toString() });
  }
}

// -------------------------------------------------------------
// ฟังก์ชันสำหรับแปลงข้อมูลเป็น JSON เพื่อส่งกลับไปยัง Frontend
// -------------------------------------------------------------
function createJsonResponse(responseObject) {
  return ContentService.createTextOutput(JSON.stringify(responseObject))
    .setMimeType(ContentService.MimeType.JSON);
}
